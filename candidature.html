<script>
  const WEBHOOK_URL = "https://discord.com/api/webhooks/1477320308351439001/mvklhBTHHPBnHnZZOEBmnFir6kFLJncOwI6OdZ8muVysyZdNs6XQtVF90mvPJmFWSRs6";

  const key = "LSM_CANDIDATURES";
  const form = document.getElementById("form");
  const msg = document.getElementById("msg");
  const list = document.getElementById("list");
  const see = document.getElementById("see");

  function getAll(){
    try { return JSON.parse(localStorage.getItem(key) || "[]"); }
    catch { return []; }
  }

  function saveAll(arr){
    localStorage.setItem(key, JSON.stringify(arr));
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function render(){
    const items = getAll().slice().reverse();
    if (!items.length){
      list.innerHTML = "";
      return;
    }
    list.innerHTML = items.map(c => `
      <div class="card">
        <div class="card-title">${escapeHtml(c.nomrp)} <span class="badge" style="margin-left:8px;">${c.status}</span></div>
        <div class="small">Discord: ${escapeHtml(c.discord)} ‚Ä¢ √Çge: ${escapeHtml(c.age)} ‚Ä¢ XP: ${escapeHtml(c.xp)}</div>
        <hr class="hr"/>
        <div class="small"><b>Motivation:</b> ${escapeHtml(c.motivation).slice(0,240)}...</div>
        <div class="small" style="margin-top:6px;"><b>Background:</b> ${escapeHtml(c.background).slice(0,240)}...</div>
        <div class="small" style="margin-top:10px;opacity:.75;">Envoy√©e le: ${new Date(c.createdAt).toLocaleString()}</div>
      </div>
    `).join("");
  }

  async function sendToDiscord(c){
    // message simple + embed
    const payload = {
      username: "LS Midnight ‚Ä¢ Waitlist",
      embeds: [
        {
          title: "üìù Nouvelle Candidature RP (Waitlist)",
          color: 14423100,
          fields: [
            { name: "üë§ Pseudo Discord", value: c.discord || "‚Äî", inline: true },
            { name: "üéÇ √Çge", value: String(c.age || "‚Äî"), inline: true },
            { name: "üßæ Nom RP", value: c.nomrp || "‚Äî", inline: false },
            { name: "üìà Exp√©rience RP", value: c.xp || "‚Äî", inline: true },
            { name: "üî• Motivation", value: (c.motivation || "‚Äî").slice(0, 1024), inline: false },
            { name: "üìö Background", value: (c.background || "‚Äî").slice(0, 1024), inline: false },
          ],
          footer: { text: "LS Midnight : Roleplay" },
          timestamp: new Date().toISOString()
        }
      ]
    };

    const res = await fetch(WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    // Discord OK = 204
    if (!res.ok) {
      const t = await res.text().catch(() => "");
      throw new Error("Webhook error " + res.status + " " + t);
    }
  }

  // Bouton "Voir mes candidatures" (comme avant)
  if (see) see.addEventListener("click", render);

  // Envoi du formulaire
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const fd = new FormData(form);
    const c = {
      discord: String(fd.get("discord") || ""),
      age: String(fd.get("age") || ""),
      nomrp: String(fd.get("nomrp") || ""),
      xp: String(fd.get("xp") || ""),
      motivation: String(fd.get("motivation") || ""),
      background: String(fd.get("background") || ""),
      status: "Re√ßue",
      createdAt: Date.now()
    };

    // 1) Sauvegarde locale (comme avant)
    const all = getAll();
    all.push(c);
    saveAll(all);

    // 2) Envoi Discord
    msg.textContent = "‚è≥ Envoi en cours...";
    try {
      await sendToDiscord(c);
      msg.textContent = "‚úÖ Candidature envoy√©e sur Discord !";
    } catch (err) {
      console.error(err);
      msg.textContent = "‚ö†Ô∏è Candidature enregistr√©e, mais l‚Äôenvoi Discord a √©chou√©.";
    }

    form.reset();
    render();
  });
</script>
